rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Books collection với userId field
    match /books/{bookId} {
      // Chỉ cho phép đọc sách của chính mình
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      
      // Chỉ cho phép tạo sách với userId của chính mình
      allow create: if isAuthenticated() 
        && request.resource.data.userId == request.auth.uid
        && validBook();
      
      // Chỉ cho phép update/delete sách của chính mình
      allow update, delete: if isAuthenticated() 
        && resource.data.userId == request.auth.uid
        && (request.method == 'delete' || validBook());

      function isAuthenticated() {
        return request.auth != null;
      }

      // Validate fields cho create/update.
      function validBook() {
        let data = request.resource.data;

        // Chỉ cho phép các field sau
        let allowed = [
          'title',
          'author',
          'coverUrl',
          'isbn',
          'status',
          'readPages',
          'totalPages',
          'description',
          'userId',
          'createdAt',
          'updatedAt'
        ];
        
        // Kiểm tra không có field không cho phép
        let hasDisallowed = data.keys().hasAny(data.keys().toSet().difference(allowed.toSet()));
        if (hasDisallowed) return false;

        // userId phải match với auth
        if (data.userId != request.auth.uid) return false;

        // status hợp lệ (0=wantToRead, 1=reading, 2=read)
        if (!(data.status is int && data.status >= 0 && data.status <= 2)) return false;

        // validate số trang
        if (!(data.readPages is int && data.totalPages is int)) return false;
        if (!(0 <= data.readPages && data.readPages <= data.totalPages && data.totalPages >= 0)) return false;

        // giới hạn độ dài chuỗi
        if (!(data.title is string && data.title.size() >= 1 && data.title.size() <= 200)) return false;
        if (data.author is string && data.author.size() > 200) return false;
        if (data.description is string && data.description.size() > 5000) return false;
        if (data.isbn is string && data.isbn.size() > 32) return false;

        return true;
      }
    }

    // Notes collection rules
    match /notes/{noteId} {
      allow read, write: if isAuthenticated() 
        && request.resource.data.userId == request.auth.uid;
      
      function isAuthenticated() {
        return request.auth != null;
      }
    }

    // Flashcards collection rules
    match /flashcards/{flashcardId} {
      allow read, write: if isAuthenticated() 
        && request.resource.data.userId == request.auth.uid;
      
      function isAuthenticated() {
        return request.auth != null;
      }
    }
  }
}
